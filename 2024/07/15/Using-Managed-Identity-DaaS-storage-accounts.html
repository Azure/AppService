<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.16.5 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Managed Identity Support for storage accounts used in Diagnostic Tools under Diagnose and Solve blade - Azure App Service</title>
<meta name="description" content="We are pleased to announce Managed Identity support for authenticating against storage accounts used for diagnostic tools under Diagnostics and a Service. This feature allows the use of both system-assigned and user-assigned managed identities as authentication mechanisms for connecting to storage accounts where memory dumps and other diagnostic data are stored.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Azure App Service">
<meta property="og:title" content="Managed Identity Support for storage accounts used in Diagnostic Tools under Diagnose and Solve blade">
<meta property="og:url" content="https://azure.github.io/AppService/2024/07/15/Using-Managed-Identity-DaaS-storage-accounts.html">


  <meta property="og:description" content="We are pleased to announce Managed Identity support for authenticating against storage accounts used for diagnostic tools under Diagnostics and a Service. This feature allows the use of both system-assigned and user-assigned managed identities as authentication mechanisms for connecting to storage accounts where memory dumps and other diagnostic data are stored.">



  <meta property="og:image" content="https://azure.github.io/AppService/assets/images/icon.png">





  <meta property="article:published_time" content="2024-07-15T00:00:00+00:00">





  

  


<link rel="canonical" href="https://azure.github.io/AppService/2024/07/15/Using-Managed-Identity-DaaS-storage-accounts.html">





  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://azure.github.io/AppService",
      "logo": "https://azure.github.io/AppService/assets/images/icon.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Azure App Service",
      "url": "https://azure.github.io/AppService",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/AppService/feed.xml" type="application/atom+xml" rel="alternate" title="Azure App Service Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/AppService/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->

<!-- Jekyll env: production -->



    <!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="icon" 
      type="image/png" 
      href="/AppService/media/pages/new_app_service_logo_16.png">
<link rel="shortcut icon" 
      type="image/png" 
      href="/AppService/media/pages/new_app_service_logo_16.png">

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/AppService/"><img src="/AppService/media/pages/new_app_service_logo_64.svg" alt=""></a>
        
        <a class="site-title" href="/AppService/">
          Azure App Service
          <span class="site-subtitle">Team Blog</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/AppService/tags/" >Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          
          

          <a href="/AppService/"><span class="nav__sub-title">Home</span></a>
        

        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Product Areas</span>
        

        
        <ul>
          
            
            

            
            

            <li>
              <a href="/AppService/networking/" class="">Networking & ASE</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/java/" class="">Java</a>
              
                
                
                
                
    
                
                
                <ul>
                  <li style="padding-left: 6px;"><a href="/AppService/java/videos/" class="">Videos</a></li>
                </ul>
                
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/diagnostics/" class="">Diagnostics</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/certsdomains/" class="">Certs and Domains</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/deployment/" class="">Deployment, CI/CD, Slots</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/windows-containers/" class="">Windows Containers</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/sidecars/" class="">Sidecars</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/ai-integration/" class="">AI Integration</a>
              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Reference</span>
        

        
        <ul>
          
            
            

            
            

            <li>
              <a href="https://docs.microsoft.com/azure/app-service/" class="">Documentation</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="https://github.com/Azure/app-service-linux-docs" class="">Linux FAQ</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="https://aka.ms/appservicewindowscontainerwiki" class="">Windows Containers Wiki</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/zero-to-hero/" class="">Zero to Hero tutorials</a>
              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">More</span>
        

        
        <ul>
          
            
            

            
            

            <li>
              <a href="https://twitter.com/Azure" class="">Twitter</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/feed.xml" class="">RSS Feed</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="https://azure.microsoft.com/blog/" class="">Azure Blog</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="https://azure.microsoft.com/updates/" class="">Azure Updates</a>
              
            </li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Archives</span>
        

        
        <ul>
          
            
            

            
            

            <li>
              <a href="/AppService/2020" class="">2020</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/2019" class="">2019</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/2018" class="">2018</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/2017" class="">2017</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/2016" class="">2016</a>
              
            </li>
          
            
            

            
            

            <li>
              <a href="/AppService/posts/" class="">All posts</a>
              
            </li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Managed Identity Support for storage accounts used in Diagnostic Tools under Diagnose and Solve blade">
    <meta itemprop="description" content="We are pleased to announce Managed Identity support for authenticating against storage accounts used for diagnostic tools under Diagnostics and a Service. This feature allows the use of both system-assigned and user-assigned managed identities as authentication mechanisms for connecting to storage accounts where memory dumps and other diagnostic data are stored.">
    <meta itemprop="datePublished" content="July 15, 2024">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Managed Identity Support for storage accounts used in Diagnostic Tools under Diagnose and Solve blade
</h1>
          <p class="page__meta">
            
              <i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

            
            
              • By Puneet Gupta
            
            • July 15, 2024
          </p>
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>We are pleased to announce <strong>Managed Identity</strong> support for authenticating against storage accounts used for diagnostic tools under Diagnostics and a Service. This feature allows the use of both system-assigned and user-assigned managed identities as authentication mechanisms for connecting to storage accounts where memory dumps and other diagnostic data are stored.</p>

<h3 id="key-benefits">Key Benefits</h3>
<ul>
  <li>Enhanced Security: Managed Identity enhances security by eliminating the need for Key-based authentication on the storage account.</li>
  <li>Compatibility: Managed Identity for storage accounts can be used with applications hosted on both Windows and Linux App Service plans.</li>
</ul>

<h3 id="usage-details">Usage Details</h3>
<ol>
  <li>Navigate to your App Service web app in the Azure Portal.</li>
  <li>Select <strong>Diagnose and Solve problems</strong>.</li>
  <li>Navigate to the <strong>Diagnostic Tools</strong> category and select the <strong>Collect Memory Dump</strong> option.</li>
  <li>Here, you will see the <strong>Authentication</strong> setting, under the storage account name, which displays the authentication method used to connect to the storage account. If your application is preconfigured with a storage account, you might encounter a warning indicating the use of <strong>Account Key or SAS</strong> based authentication to connect to the storage account.</li>
</ol>

<blockquote>
  <p><img src="/AppService/media/2024/07/daas-storage-account.png" alt="" /></p>
</blockquote>

<p>When you click <strong>Change</strong>, you can select from the managed identities already configured on the app.</p>

<blockquote>
  <p><img src="/AppService/media/2024/07/daas-storage-choose-msi.png" alt="" /></p>
</blockquote>

<p>Upon hitting Save, the chosen user identity will be added to the following access roles on the storage account:</p>
<ul>
  <li>Storage Blob Data Contributor</li>
  <li>Storage Table Data Contributor</li>
  <li>Storage Queue Data Contributor</li>
</ul>

<blockquote>
  <p><img src="/AppService/media/2024/07/daas-storage-after-msi.png" alt="" /></p>
</blockquote>

<p>From this point forward, the diagnostic service will use this managed identity to connect to the configured storage account. You can then disable Key-based authentication by adjusting the settings of the storage account.</p>

<h3 id="automating-via-powershell">Automating via PowerShell</h3>
<p>Below is a sample script demonstrating how to update the storage account authentication for an Azure Web App to use Managed Service Identity (MSI). The script updates the storage account configuration for the web app and all its slots.</p>

<blockquote>
  <p>Disclaimer - This script is provided for illustration purposes only. Please test it on a staging or test app before applying it to a production web app.</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$SubscriptionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;Your_Subscription_Id&gt;"</span><span class="w">

</span><span class="c"># Specify Managed Identity Name and resource group</span><span class="w">
</span><span class="nv">$managedIdentityName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;ManagedIdentityName&gt;'</span><span class="w">
</span><span class="nv">$managedIdentityResourceGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;ManagedIdentityResourceGroup&gt;'</span><span class="w">

</span><span class="c"># Specify Storage account name and resource group</span><span class="w">
</span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;StorageAccountName&gt;'</span><span class="w">
</span><span class="nv">$storageAccountResourceGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'&lt;StorageAccountResourceGroup&gt;'</span><span class="w">

</span><span class="c"># Specify web app name and resource group</span><span class="w">
</span><span class="nv">$webAppName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;WebAppName&gt;"</span><span class="w">
</span><span class="nv">$webAppResourceGroupName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;WebAppResourceGroup&gt;"</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">addRole</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w"> </span><span class="nv">$storageAccountResourceId</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w"> </span><span class="nv">$managedIdentityPrincipalId</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w"> </span><span class="nv">$roleId</span><span class="p">,</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w"> </span><span class="nv">$roleName</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="nv">$accountName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$storageAccountResourceId</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'//'</span><span class="p">)[</span><span class="nt">-1</span><span class="p">]</span><span class="w">
    </span><span class="s2">"Adding [</span><span class="nv">$roleName</span><span class="s2">] for principal [</span><span class="nv">$managedIdentityPrincipalId</span><span class="s2">] to account - "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$accountName</span><span class="w">

    </span><span class="nv">$roleAssignmentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">guid</span><span class="p">]::</span><span class="n">NewGuid</span><span class="p">()</span><span class="w">
    </span><span class="nv">$ResourceUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://management.azure.com/"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$storageAccountResourceId</span><span class="w"> 
    </span><span class="nv">$ResourceUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ResourceUri</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"/providers/Microsoft.Authorization/roleAssignments/</span><span class="nv">$roleAssignmentId</span><span class="s2">"</span><span class="w">
    </span><span class="nv">$ResourceUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ResourceUri</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"?api-version=2022-04-01"</span><span class="w">

    </span><span class="nv">$Body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
      </span><span class="nx">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
        </span><span class="nx">principalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$managedIdentityPrincipalId</span><span class="s2">"</span><span class="w">
        </span><span class="nx">roleDefinitionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$storageAccountResourceId</span><span class="s2">/providers/Microsoft.Authorization/roleDefinitions/</span><span class="nv">$roleId</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="w"> </span><span class="nt">-Depth</span><span class="w"> </span><span class="nx">3</span><span class="w">

    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nv">$ResourceUri</span><span class="w"> </span><span class="nt">-Headers</span><span class="w"> </span><span class="nv">$Headers</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="nv">$Body</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">PUT</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">catch</span><span class="p">{</span><span class="w">
       </span><span class="nv">$responseError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">ErrorDetails</span><span class="o">.</span><span class="nf">Message</span><span class="w">
       </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$responseError</span><span class="o">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s2">"The role assignment already exists"</span><span class="p">)){</span><span class="w">
        </span><span class="n">Write-Host</span><span class="w"> </span><span class="s2">"The [</span><span class="nv">$managedIdentityPrincipalId</span><span class="s2">] already exists in [</span><span class="nv">$roleName</span><span class="s2">] on [</span><span class="nv">$accountName</span><span class="s2">]"</span><span class="w">
       </span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">throw</span><span class="w">
       </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Login to Azure if not already logged in</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="p">(</span><span class="n">Get-AzContext</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Connect-AzAccount</span><span class="w">  
</span><span class="p">}</span><span class="w">

</span><span class="n">Set-AzContext</span><span class="w"> </span><span class="nt">-Subscription</span><span class="w"> </span><span class="nv">$SubscriptionId</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="nv">$context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzContext</span><span class="w">

</span><span class="nv">$managedIdentity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzUserAssignedIdentity</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$managedIdentityResourceGroup</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$managedIdentityName</span><span class="w">
</span><span class="nv">$Identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$managedIdentity</span><span class="o">.</span><span class="nf">Id</span><span class="w">
</span><span class="s2">"Managed Identity Id is "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$Identity</span><span class="w">

</span><span class="c"># Get the access token</span><span class="w">
</span><span class="nv">$AzureRmProfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider</span><span class="p">]::</span><span class="n">Instance.Profile</span><span class="w">  
</span><span class="nv">$ProfileClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">Microsoft.Azure.Commands.ResourceManager.Common.RMProfileClient</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="p">(</span><span class="nv">$AzureRmProfile</span><span class="p">)</span><span class="w">  
</span><span class="nv">$Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ProfileClient</span><span class="o">.</span><span class="nf">AcquireAccessToken</span><span class="p">(</span><span class="nv">$context</span><span class="o">.</span><span class="nf">Subscription</span><span class="o">.</span><span class="nf">TenantId</span><span class="p">)</span><span class="w">

</span><span class="c"># Prepare the header with the Bearer token  </span><span class="w">
</span><span class="nv">$Headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">  
    </span><span class="s1">'Authorization'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Bearer '</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="nv">$Token</span><span class="err">.</span><span class="nx">AccessToken</span><span class="w">  
    </span><span class="s1">'Content-Type'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/json'</span><span class="w">  
</span><span class="p">}</span><span class="w">

</span><span class="nv">$account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzStorageAccount</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$storageAccountName</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$storageAccountResourceGroup</span><span class="w">
</span><span class="nv">$storageAccountResourceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$account</span><span class="o">.</span><span class="nf">Id</span><span class="w">

</span><span class="c">#https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles</span><span class="w">
</span><span class="n">addRole</span><span class="w"> </span><span class="nt">-storageAccountResourceId</span><span class="w"> </span><span class="nv">$account</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-managedIdentityPrincipalId</span><span class="w"> </span><span class="nv">$managedIdentity</span><span class="o">.</span><span class="nf">PrincipalId</span><span class="w"> </span><span class="nt">-roleId</span><span class="w"> </span><span class="s2">"ba92f5b4-2d11-453d-a403-e96b0029c9fe"</span><span class="w"> </span><span class="nt">-roleName</span><span class="w"> </span><span class="s2">"Storage Blob Data Contributor"</span><span class="w">
</span><span class="n">addRole</span><span class="w"> </span><span class="nt">-storageAccountResourceId</span><span class="w"> </span><span class="nv">$account</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-managedIdentityPrincipalId</span><span class="w"> </span><span class="nv">$managedIdentity</span><span class="o">.</span><span class="nf">PrincipalId</span><span class="w"> </span><span class="nt">-roleId</span><span class="w"> </span><span class="s2">"0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3"</span><span class="w"> </span><span class="nt">-roleName</span><span class="w"> </span><span class="s2">"Storage Table Data Contributor"</span><span class="w">
</span><span class="n">addRole</span><span class="w"> </span><span class="nt">-storageAccountResourceId</span><span class="w"> </span><span class="nv">$account</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-managedIdentityPrincipalId</span><span class="w"> </span><span class="nv">$managedIdentity</span><span class="o">.</span><span class="nf">PrincipalId</span><span class="w"> </span><span class="nt">-roleId</span><span class="w"> </span><span class="s2">"974c5e8b-45b9-4653-ba55-5f855dd0fb88"</span><span class="w"> </span><span class="nt">-roleName</span><span class="w"> </span><span class="s2">"Storage Queue Data Contributor"</span><span class="w">

</span><span class="s2">"Getting WebApp app settings"</span><span class="w">
</span><span class="nv">$webApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzWebApp</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$webAppResourceGroupName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$webAppName</span><span class="w">
</span><span class="nv">$appSettings</span><span class="o">=</span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">SiteConfig</span><span class="o">.</span><span class="nf">AppSettings</span><span class="w">

</span><span class="nv">$newAppSettings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{}</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$appSettings</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nv">$newAppSettings</span><span class="p">[</span><span class="nv">$item</span><span class="o">.</span><span class="nf">Name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$item</span><span class="o">.</span><span class="nf">Value</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$connectionString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"DefaultEndpointsProtocol=https;AccountName=</span><span class="si">$(</span><span class="nv">$account</span><span class="o">.</span><span class="nf">StorageAccountName</span><span class="si">)</span><span class="s2">;ManagedIdentityClientId=</span><span class="si">$(</span><span class="nv">$managedIdentity</span><span class="o">.</span><span class="nf">ClientId</span><span class="si">)</span><span class="s2">;EndpointSuffix=core.windows.net"</span><span class="w">
</span><span class="nv">$newAppSettings</span><span class="p">[</span><span class="s1">'WEBSITE_DAAS_STORAGE_CONNECTIONSTRING'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$connectionString</span><span class="w">
 
</span><span class="s2">"Updating AppSettings for "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w">
</span><span class="n">Set-AzWebApp</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$webAppResourceGroupName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-AppSettings</span><span class="w"> </span><span class="nv">$newAppSettings</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
</span><span class="s2">"App Setting updated"</span><span class="w">

</span><span class="s2">"Getting slots for "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w">
</span><span class="nv">$slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@()</span><span class="w">
</span><span class="nv">$slotsWebApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzWebAppSlot</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$webAppResourceGroupName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w">
</span><span class="nx">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$slotsWebApp</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="bp">$null</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="nv">$slotsWebApp</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="bp">$null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$slotName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$slotsWebApp</span><span class="o">.</span><span class="nf">Name</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="w">
    </span><span class="nv">$slots</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nv">$slotName</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$slotName</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$slots</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$slotWebApp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzWebAppSlot</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$webAppResourceGroupName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-Slot</span><span class="w"> </span><span class="nv">$slotName</span><span class="w">
    </span><span class="nv">$appSettingsSlot</span><span class="w"> </span><span class="o">=</span><span class="nv">$slotWebApp</span><span class="o">.</span><span class="nf">SiteConfig</span><span class="o">.</span><span class="nf">AppSettings</span><span class="w">
    </span><span class="nv">$newAppSettingsSlot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{}</span><span class="w">

    </span><span class="kr">foreach</span><span class="p">(</span><span class="nv">$item</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$appSettingsSlot</span><span class="p">){</span><span class="w">
        </span><span class="nv">$newAppSettingsSlot</span><span class="p">[</span><span class="nv">$item</span><span class="o">.</span><span class="nf">Name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$item</span><span class="o">.</span><span class="nf">Value</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="nv">$newAppSettingsSlot</span><span class="p">[</span><span class="s1">'WEBSITE_DAAS_STORAGE_CONNECTIONSTRING'</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$connectionString</span><span class="w">
    </span><span class="s2">"Updating AppSettings for "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"(</span><span class="nv">$slotName</span><span class="s2">)"</span><span class="w">
    </span><span class="n">Set-AzWebAppSlot</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="nv">$webAppResourceGroupName</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="nt">-AppSettings</span><span class="w"> </span><span class="nv">$newAppSettingsSlot</span><span class="w"> </span><span class="nt">-Slot</span><span class="w"> </span><span class="nv">$slotName</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-Null</span><span class="w">
    </span><span class="s2">"AppSettings updated for "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$webApp</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"(</span><span class="nv">$slotName</span><span class="s2">)"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

        
      </section>

      <footer class="page__meta">
          <p class="page__date"><strong><a href="https://docs.microsoft.com/answers/topics/azure-webapps.html">Post questions</a> | <a href="https://feedback.azure.com/forums/169385-web-apps">Provide product feedback</a></strong></p>
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2024-07-15T00:00:00+00:00">July 15, 2024</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Managed+Identity+Support+for+storage+accounts+used+in+Diagnostic+Tools+under+Diagnose+and+Solve+blade%20https%3A%2F%2Fazure.github.io%2FAppService%2F2024%2F07%2F15%2FUsing-Managed-Identity-DaaS-storage-accounts.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fazure.github.io%2FAppService%2F2024%2F07%2F15%2FUsing-Managed-Identity-DaaS-storage-accounts.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fazure.github.io%2FAppService%2F2024%2F07%2F15%2FUsing-Managed-Identity-DaaS-storage-accounts.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/AppService/2024/07/15/Monitoring-crashes-in-child-processes.html" class="pagination--pager" title="Crash Monitoring for child processes
">Previous</a>
    
    
      <a href="/AppService/2024/07/19/Using-Redis-with-Sidecar.html" class="pagination--pager" title="Leveraging Redis as a Sidecar for Linux App Service
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/AppService/media/pages/new_app_service_logo_64.svg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/AppService/2025/11/04/app-service-agent-framework-part-3.html" rel="permalink">Part 3: Client-Side Multi-Agent Orchestration on Azure App Service with Microsoft Agent Framework
</a>
      
    </h2>
    
      <p class="page__meta">
        
          <i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read

        
        
          • By Jordan Selig
        
        • November 4, 2025
      </p>
    
    <p class="archive__item-excerpt" itemprop="description">In Part 2 of this series, I showed you how to build sophisticated multi-agent systems on Azure App Service using Azure AI Foundry Agents—server-side managed ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/AppService/media/pages/new_app_service_logo_64.svg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/AppService/2025/10/31/app-service-agent-framework-part-2.html" rel="permalink">Part 2: Build Long-Running AI Agents on Azure App Service with Microsoft Agent Framework
</a>
      
    </h2>
    
      <p class="page__meta">
        
          <i class="far fa-clock" aria-hidden="true"></i> 




  9 minute read

        
        
          • By Jordan Selig
        
        • October 31, 2025
      </p>
    
    <p class="archive__item-excerpt" itemprop="description">Last week, I shared how to build long-running AI agents on Azure App Service with Microsoft Agent Framework. If you haven’t seen that post yet, I would recom...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/AppService/media/pages/new_app_service_logo_64.svg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/AppService/2025/10/29/node24-available.html" rel="permalink">Node.js 24 is now available on Azure App Service for Linux
</a>
      
    </h2>
    
      <p class="page__meta">
        
          <i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read

        
        
          • By Tulika Chaudharie
        
        • October 29, 2025
      </p>
    
    <p class="archive__item-excerpt" itemprop="description">Node.js 24 LTS is live on Azure App Service for Linux. You can create a new Node 24 app through the Azure portal, automate it with the Azure CLI, or roll it ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src=
          
            "/AppService/media/pages/new_app_service_logo_64.svg"
          
          alt="">
      </div>
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/AppService/2025/10/29/VSTS-tasks-for-sidecars.html" rel="permalink">Azure Pipeline samples: add sidecars to Azure App Service for Linux
</a>
      
    </h2>
    
      <p class="page__meta">
        
          <i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

        
        
          • By Tulika Chaudharie
        
        • October 29, 2025
      </p>
    
    <p class="archive__item-excerpt" itemprop="description">Sidecars on Azure App Service let you attach extra containers — logging, telemetry, lightweight APIs, caches, AI inference helpers — alongside your main app,...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id">
    <label class="sr-only" for="cse-search-input-box-id">
      Enter your search term...
    </label>
    <input type="search" id="cse-search-input-box-id" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results">
    <gcse:searchresults-only></gcse:searchresults-only>
  </div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        

<div class="page__footer-follow">
  
    <a class="page-microsoft" href="https://www.microsoft.com"><img src="/AppService/media/pages/Microsoft_logo.svg" alt=""></a>
  
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/AzAppService" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/Azure/AppService" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    <li><a href="/AppService/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2025 Azure App Service. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/AppService/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>


<script>
  (function () {
    var cx = '015057007851139702326:ob8gaepprli';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
    $(document).ready(function () {
      $('input#cse-search-input-box-id').on('keyup', function () {
        googleCustomSearchExecute();
      });
    });
  
</script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-112478220-2']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>









  </body>
</html>
